#!/usr/bin/env bash
# Talkie service management CLI
# Usage: ./talkie <command> [options]

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_debug() {
    echo -e "${BLUE}[DEBUG]${NC} $1"
}

# Check if podman is installed
check_podman() {
    if ! command -v podman &> /dev/null; then
        log_error "Podman is not installed."
        echo "Install Podman:"
        echo "  macOS: brew install podman"
        echo "  Linux: See https://podman.io/getting-started/installation"
        exit 1
    fi
}

# Check if podman-compose is available
check_podman_compose() {
    if command -v podman-compose &> /dev/null; then
        COMPOSE_CMD="podman-compose"
    elif podman compose version &> /dev/null 2>&1; then
        COMPOSE_CMD="podman compose"
    else
        log_error "podman-compose not found. Install it:"
        echo "  pip install podman-compose"
        echo "  or use podman compose (requires podman 4.0+)"
        exit 1
    fi
}

# Initialize compose command
init_compose() {
    check_podman
    check_podman_compose
}

# Single compose service names (for: ./talkie start haproxy, etc.)
COMPOSE_SERVICES="consul-server keydb haproxy ollama chroma speech rag browser healthbeat"

# Start services
cmd_start() {
    local services="${1:-all}"
    local svc

    if [ "$services" = "web" ]; then
        cmd_web_start
        return
    fi
    for svc in $COMPOSE_SERVICES; do
        if [ "$services" = "$svc" ]; then
            init_compose
            log_info "Starting $services..."
            $COMPOSE_CMD up -d "$services"
            return
        fi
    done

    init_compose
    log_info "Starting Talkie services..."

    if [ "$services" = "all" ] || [ "$services" = "infrastructure" ]; then
        log_info "Starting infrastructure services..."
        $COMPOSE_CMD up -d consul-server keydb haproxy
        sleep 2
    fi

    if [ "$services" = "all" ] || [ "$services" = "core" ]; then
        log_info "Starting core services (Ollama, Chroma)..."
        $COMPOSE_CMD up -d ollama chroma
        sleep 2
    fi

    if [ "$services" = "all" ] || [ "$services" = "modules" ]; then
        log_info "Starting module servers..."
        $COMPOSE_CMD up -d speech rag browser healthbeat
        sleep 2
    fi

    if [ "$services" = "all" ]; then
        log_info "Starting Web UI (background)..."
        cmd_web_start
        log_info "All services started"
        cmd_status
    fi
}

# Stop services
cmd_stop() {
    local services="${1:-all}"
    local svc

    if [ "$services" = "web" ]; then
        cmd_web_stop
        return
    fi
    for svc in $COMPOSE_SERVICES; do
        if [ "$services" = "$svc" ]; then
            init_compose
            log_info "Stopping $services..."
            $COMPOSE_CMD stop "$services" 2>/dev/null || true
            log_info "Services stopped"
            return
        fi
    done

    init_compose
    log_info "Stopping Talkie services..."

    if [ "$services" = "all" ]; then
        cmd_web_stop
    fi

    if [ "$services" = "all" ] || [ "$services" = "modules" ]; then
        log_info "Stopping module servers..."
        $COMPOSE_CMD stop speech rag browser healthbeat 2>/dev/null || true
    fi

    if [ "$services" = "all" ] || [ "$services" = "core" ]; then
        log_info "Stopping core services..."
        $COMPOSE_CMD stop ollama chroma 2>/dev/null || true
    fi

    if [ "$services" = "all" ] || [ "$services" = "infrastructure" ]; then
        log_info "Stopping infrastructure services..."
        $COMPOSE_CMD stop consul-server keydb haproxy 2>/dev/null || true
    fi

    log_info "Services stopped"
}

# Restart services (use compose restart for containers to avoid "name already in use")
cmd_restart() {
    local services="${1:-all}"
    local svc

    log_info "Restarting services: $services"

    if [ "$services" = "web" ]; then
        cmd_web_restart
        return
    fi
    for svc in $COMPOSE_SERVICES; do
        if [ "$services" = "$svc" ]; then
            init_compose
            log_info "Restarting $services..."
            $COMPOSE_CMD restart "$services" 2>/dev/null || true
            return
        fi
    done

    if [ "$services" = "all" ]; then
        init_compose
        log_info "Stopping all services..."
        cmd_stop "all"
        sleep 2
        log_info "Starting all services..."
        cmd_start "all"
        return
    fi

    # infrastructure | core | modules
    init_compose
    cmd_stop "$services"
    sleep 1
    cmd_start "$services"
}

# Web server PID/log files
WEB_PID_FILE="$SCRIPT_DIR/.talkie-web.pid"
WEB_LOG_FILE="$SCRIPT_DIR/.talkie-web.log"

cmd_web_start() {
    if [ -f "$WEB_PID_FILE" ]; then
        local pid
        pid=$(cat "$WEB_PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            log_info "Web UI already running (PID $pid). http://localhost:8765"
            return 0
        fi
        rm -f "$WEB_PID_FILE"
    fi
    # If port 8765 is in use (e.g. stale process), free it before starting
    if command -v lsof &>/dev/null; then
        local port_pid
        port_pid=$(lsof -ti :8765 2>/dev/null | head -1)
        if [ -n "$port_pid" ]; then
            log_info "Killing process $port_pid holding port 8765"
            kill "$port_pid" 2>/dev/null || true
            sleep 2
        fi
    fi
    log_info "Starting Talkie Web UI..."
    ( cd "$SCRIPT_DIR" && nohup pipenv run python run_web.py >> "$WEB_LOG_FILE" 2>&1 & echo $! > "$WEB_PID_FILE" )
    sleep 1
    if [ -f "$WEB_PID_FILE" ] && kill -0 "$(cat "$WEB_PID_FILE")" 2>/dev/null; then
        log_info "Web UI started (PID $(cat "$WEB_PID_FILE")). http://localhost:8765"
    else
        log_error "Web UI failed to start. Check $WEB_LOG_FILE"
        rm -f "$WEB_PID_FILE"
        exit 1
    fi
}

cmd_web_stop() {
    if [ -f "$WEB_PID_FILE" ]; then
        local pid
        pid=$(cat "$WEB_PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null || true
            sleep 1
            kill -9 "$pid" 2>/dev/null || true
        fi
        rm -f "$WEB_PID_FILE"
        log_info "Web UI stopped"
    else
        log_info "Web UI not running"
    fi
}

cmd_web_restart() {
    cmd_web_stop
    sleep 1
    cmd_web_start
}

# Check if port 8765 is listening (macOS and Linux)
web_port_listening() {
    if command -v lsof &>/dev/null; then
        lsof -i :8765 2>/dev/null | grep -q LISTEN
    else
        [ -n "$(ss -tln 2>/dev/null | grep ':8765 ')" ] || [ -n "$(netstat -tln 2>/dev/null | grep ':8765 ')" ]
    fi
}

cmd_web_status() {
    if [ -f "$WEB_PID_FILE" ]; then
        local pid
        pid=$(cat "$WEB_PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            if web_port_listening; then
                echo -e "Web UI: ${GREEN}running${NC} (PID $pid, port 8765). http://localhost:8765"
            else
                echo -e "Web UI: process running (PID $pid) but ${YELLOW}port 8765 not listening${NC}. Check $WEB_LOG_FILE"
            fi
        else
            echo -e "Web UI: ${RED}stopped${NC} (stale PID file removed)"
            rm -f "$WEB_PID_FILE"
        fi
    else
        if web_port_listening; then
            echo -e "Web UI: port 8765 in use by another process (not managed by talkie)"
        else
            echo -e "Web UI: ${RED}stopped${NC}. Run: ./talkie start web"
        fi
    fi
}

# --- App command (replaces start.sh): bring up services then run UI ---
is_container_running() {
    local container_name=$1
    podman ps --format "{{.Names}}" | grep -q "^${container_name}$"
}

app_check_container_health() {
    local container_name=$1
    local max_attempts=${2:-10}
    local attempt=0
    while [ $attempt -lt $max_attempts ]; do
        local health
        health=$(podman inspect --format='{{.State.Health.Status}}' "$container_name" 2>/dev/null || echo "none")
        if [ "$health" = "healthy" ]; then return 0; fi
        if [ "$health" = "unhealthy" ]; then return 1; fi
        if [ "$health" = "none" ] || [ "$health" = "" ]; then
            is_container_running "$container_name" && return 0 || return 1
        fi
        attempt=$((attempt + 1))
        sleep 1
    done
    return 1
}

app_health_check_service() {
    local service_name=$1
    local container_name=$2
    local check_url=$3
    if ! is_container_running "$container_name"; then
        log_warn "$service_name container ($container_name) is not running"
        return 1
    fi
    if [ -n "$check_url" ]; then
        if curl -s -f "$check_url" > /dev/null 2>&1; then
            log_info "$service_name is healthy"
            return 0
        else
            log_warn "$service_name is running but health check failed at $check_url"
            return 1
        fi
    fi
    if app_check_container_health "$container_name" 3; then
        log_info "$service_name is healthy"
        return 0
    else
        log_warn "$service_name container exists but health check failed"
        return 1
    fi
}

app_check_python() {
    if ! command -v python3 &> /dev/null; then
        log_error "Python 3 is not installed."
        echo "Install Python 3.11+: macOS: brew install python@3.11"
        exit 1
    fi
    log_info "Python found: $(python3 --version 2>&1)"
    if ! command -v pipenv &> /dev/null; then
        log_warn "pipenv not found. Installing..."
        pip3 install --user pipenv || { log_error "Failed to install pipenv."; exit 1; }
        export PATH="$HOME/.local/bin:$PATH"
    fi
    log_info "pipenv found: $(pipenv --version)"
}

app_install_deps() {
    local need_install=false
    if [ ! -f "Pipfile.lock" ] || [ "Pipfile" -nt "Pipfile.lock" ]; then need_install=true; fi
    if [ "$need_install" = true ]; then
        log_info "Installing/updating Python dependencies..."
        pipenv install --dev || { log_error "Failed to install dependencies."; exit 1; }
    else
        if ! pipenv --venv &> /dev/null; then
            pipenv install --dev || { log_error "Failed to install dependencies."; exit 1; }
        fi
    fi
}

app_setup_data_dir() {
    [ ! -d "data" ] && mkdir -p data
    if [ ! -f "config.yaml" ]; then
        log_error "config.yaml not found."
        exit 1
    fi
}

app_check_ollama_models() {
    log_info "Checking Ollama models..."
    if ! is_container_running "talkie-ollama"; then
        log_warn "Ollama container not running. Starting it..."
        $COMPOSE_CMD up -d ollama
        sleep 5
    else
        local health_status
        health_status=$(podman inspect --format='{{.State.Health.Status}}' "talkie-ollama" 2>/dev/null || echo "none")
        if [ "$health_status" = "unhealthy" ]; then
            $COMPOSE_CMD restart ollama
            sleep 5
        elif ! curl -s -f http://localhost:11434/api/tags > /dev/null 2>&1; then
            if [ "$health_status" != "healthy" ]; then sleep 5; else $COMPOSE_CMD restart ollama; sleep 5; fi
        fi
    fi
    if ! curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
        log_info "Waiting for Ollama..."
        sleep 10
        if ! curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
            log_error "Ollama not responding. Check: podman logs talkie-ollama"
            exit 1
        fi
    fi
    local DEFAULT_MODEL=phi
    [ -f config.yaml ] && DEFAULT_MODEL=$(grep -E "^\s*model_name:" config.yaml | head -1 | sed 's/.*model_name:\s*\([^ ]*\).*/\1/' | tr -d '"' || echo "phi")
    local MODELS_JSON MODELS MODEL_FOR_API
    MODELS_JSON=$(curl -s http://localhost:11434/api/tags 2>/dev/null || echo "{}")
    MODELS=$(echo "$MODELS_JSON" | grep -o '"name":"[^"]*"' | cut -d'"' -f4 || echo "")
    if ! echo "$MODELS" | grep -qE "^${DEFAULT_MODEL}(:|$)"; then
        log_info "Pulling model '$DEFAULT_MODEL'..."
        podman exec talkie-ollama ollama pull "$DEFAULT_MODEL"
        MODELS_JSON=$(curl -s http://localhost:11434/api/tags 2>/dev/null || echo "{}")
        MODELS=$(echo "$MODELS_JSON" | grep -o '"name":"[^"]*"' | cut -d'"' -f4 || echo "")
    fi
    log_info "Warming up Ollama model '$DEFAULT_MODEL'..."
    MODEL_FOR_API=$(echo "$MODELS" | grep -E "^${DEFAULT_MODEL}(:|$)" | head -1)
    [ -z "$MODEL_FOR_API" ] && MODEL_FOR_API="$DEFAULT_MODEL"
    if ! curl -s -X POST http://localhost:11434/api/generate -H "Content-Type: application/json" \
        -d "{\"model\":\"$MODEL_FOR_API\",\"prompt\":\"ok\",\"stream\":false}" --max-time 90 > /dev/null 2>&1; then
        log_warn "Ollama warmup failed (first request may 500)."
    fi
    if [ -f config.yaml ] && grep -q "embedding_model:" config.yaml; then
        local EMBED_MODEL
        EMBED_MODEL=$(grep -E "^\s*embedding_model:" config.yaml | head -1 | sed 's/.*embedding_model:\s*\([^ ]*\).*/\1/' | tr -d '"' || echo "")
        if [ -n "$EMBED_MODEL" ] && ! echo "$MODELS" | grep -qE "^${EMBED_MODEL}(:|$)"; then
            log_info "Pulling embedding model '$EMBED_MODEL'..."
            podman exec talkie-ollama ollama pull "$EMBED_MODEL"
        fi
    fi
}

cmd_app() {
    local LOCAL_ONLY=0
    while [ $# -gt 0 ]; do
        case "$1" in
            --local-only) LOCAL_ONLY=1; shift ;;
            *) break ;;
        esac
    done
    init_compose
    log_info "Starting Talkie (services in containers, Web UI runs locally)..."
    [ "$LOCAL_ONLY" -eq 1 ] && log_info "Local-only: module servers will not be started"
    echo ""
    app_check_python
    app_setup_data_dir
    app_install_deps
    log_info "Prebuilding container images..."
    $COMPOSE_CMD build
    log_info "Ensuring infrastructure services are running..."
    local INFRA_SERVICES=(consul-server keydb haproxy)
    local NEED_INFRA=false
    for sn in "${INFRA_SERVICES[@]}"; do
        if ! is_container_running "talkie-$sn"; then NEED_INFRA=true; break; fi
    done
    if [ "$NEED_INFRA" = true ]; then
        $COMPOSE_CMD up -d "${INFRA_SERVICES[@]}"
        log_info "Waiting for infrastructure (20s)..."
        sleep 20
    fi
    app_health_check_service "Consul" "talkie-consul-server" "http://localhost:8500/v1/status/leader" || log_warn "Consul health check failed"
    is_container_running "talkie-keydb" && podman exec talkie-keydb keydb-cli ping > /dev/null 2>&1 && log_info "KeyDB is ready" || log_warn "KeyDB failed"
    app_health_check_service "HAProxy" "talkie-haproxy" "http://localhost:8404/" || log_warn "HAProxy health check failed"
    log_info "Ensuring application services (Ollama, Chroma)..."
    local APP_SERVICES=(ollama chroma)
    local NEED_APP=false
    for sn in "${APP_SERVICES[@]}"; do
        if ! is_container_running "talkie-$sn"; then NEED_APP=true; break; fi
    done
    if [ "$NEED_APP" = true ]; then
        $COMPOSE_CMD up -d "${APP_SERVICES[@]}"
        log_info "Waiting for application services (20s)..."
        sleep 20
    fi
    app_health_check_service "Ollama" "talkie-ollama" "http://localhost:11434/api/tags" || log_warn "Ollama health check failed"
    app_health_check_service "Chroma" "talkie-chroma" "http://localhost:8000/api/v1" || log_warn "Chroma may still be starting"
    if [ "$LOCAL_ONLY" -eq 0 ]; then
        log_info "Checking module servers..."
        local MODULE_SERVICES=("speech:talkie-speech:http://localhost:8001/health" "rag:talkie-rag:http://localhost:8002/health" "browser:talkie-browser:http://localhost:8003/health")
        local TO_START=() TO_RESTART=()
        for info in "${MODULE_SERVICES[@]}"; do
            IFS=':' read -r sn cn url <<< "$info"
            if is_container_running "$cn"; then
                local hs
                hs=$(podman inspect --format='{{.State.Health.Status}}' "$cn" 2>/dev/null || echo "none")
                if [ "$hs" = "unhealthy" ]; then TO_RESTART+=("$sn"); elif [ -n "$url" ] && ! curl -s -f "$url" > /dev/null 2>&1; then TO_RESTART+=("$sn"); else log_info "$sn is running and healthy"; fi
            else
                TO_START+=("$sn")
            fi
        done
        [ ${#TO_RESTART[@]} -gt 0 ] && $COMPOSE_CMD restart "${TO_RESTART[@]}" && sleep 2
        [ ${#TO_START[@]} -gt 0 ] && $COMPOSE_CMD up -d "${TO_START[@]}" && log_info "Module servers starting..." && sleep 3
        log_info "Consul UI: http://localhost:8500/ui"
    fi
    app_check_ollama_models
    log_info "Starting Talkie Web UI. http://localhost:8765"
    exec pipenv run python run_web.py
}

# View logs
cmd_logs() {
    local service="${1:-}"
    local follow="${2:-}"
    init_compose
    
    if [ -z "$service" ]; then
        log_info "Available services:"
        echo "  Infrastructure: consul-server, keydb, haproxy"
        echo "  Core: ollama, chroma"
        echo "  Modules: speech, rag, browser, healthbeat"
        echo ""
        echo "Usage: ./talkie logs <service> [--follow]"
        echo "Example: ./talkie logs consul-server --follow"
        return
    fi
    
    if [ "$follow" = "--follow" ] || [ "$follow" = "-f" ]; then
        podman logs -f "talkie-$service" 2>/dev/null || log_error "Service 'talkie-$service' not found or not running"
    else
        podman logs "talkie-$service" 2>/dev/null || log_error "Service 'talkie-$service' not found or not running"
    fi
}

# Status check
cmd_status() {
    init_compose
    
    log_info "Talkie service status:"
    echo ""
    
    # Check infrastructure
    echo "Infrastructure:"
    for service in consul-server keydb haproxy; do
        if podman ps --format "{{.Names}}" | grep -q "^talkie-$service$"; then
            echo -e "  ${GREEN}✓${NC} $service (running)"
        else
            echo -e "  ${RED}✗${NC} $service (stopped)"
        fi
    done

    echo ""
    echo "Core services:"
    for service in ollama chroma; do
        if podman ps --format "{{.Names}}" | grep -q "^talkie-$service$"; then
            echo -e "  ${GREEN}✓${NC} $service (running)"
        else
            echo -e "  ${RED}✗${NC} $service (stopped)"
        fi
    done

    echo ""
    echo "Module servers:"
    for service in speech rag browser healthbeat; do
        if podman ps --format "{{.Names}}" | grep -q "^talkie-$service$"; then
            echo -e "  ${GREEN}✓${NC} $service (running)"
        else
            echo -e "  ${RED}✗${NC} $service (stopped)"
        fi
    done

    echo ""
    echo "Service URLs:"
    echo "  Talkie Web UI: http://localhost:8765"
    echo "  Consul UI: http://localhost:8500/ui"
    echo "  HAProxy Stats: http://localhost:8404"
    echo "  HAProxy: http://localhost:8080"
}

# List containers
cmd_ps() {
    init_compose
    
    log_info "Talkie containers:"
    podman ps --filter "name=talkie-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

# Restart only processes whose code has changed (git diff vs HEAD)
# Maps changed paths to: main app, speech, rag, browser, healthbeat; rebuilds image if needed and restarts only affected containers
cmd_restart_changed() {
    local ref="${1:-HEAD}"
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        log_error "Not a git repository. restart-changed requires git to detect code changes."
        exit 1
    fi
    local changed
    changed=$( { git diff --name-only "$ref"; git diff --name-only --cached "$ref"; } 2>/dev/null | sort -u )
    if [ -z "$changed" ]; then
        log_info "No code changes detected (compared to $ref). Nothing to restart."
        return 0
    fi
    local main_changed=0 speech_changed=0 rag_changed=0 browser_changed=0 healthbeat_changed=0 shared_changed=0
    while IFS= read -r path; do
        [ -z "$path" ] && continue
        case "$path" in
            app/*|run.py|run_web.py|run_module_server.py|config.py|config.yaml|persistence/*|llm/*|curation/*|profile/*|web/*|sdk/*)
                main_changed=1
                ;;
            modules/speech/*)
                speech_changed=1
                ;;
            modules/rag/*)
                rag_changed=1
                ;;
            modules/browser/*)
                browser_changed=1
                ;;
            modules/api/healthbeat*)
                healthbeat_changed=1
                ;;
            modules/api/*|modules/__init__.py|modules/discovery.py)
                shared_changed=1
                ;;
        esac
    done <<< "$changed"
    if [ "$shared_changed" -eq 1 ]; then
        speech_changed=1
        rag_changed=1
        browser_changed=1
        healthbeat_changed=1
    fi
    local any_module=$(( speech_changed + rag_changed + browser_changed + healthbeat_changed ))
    if [ "$any_module" -eq 0 ]; then
        if [ "$main_changed" -eq 1 ]; then
            log_warn "Only main app code changed (app/, run.py, run_web.py, config, etc.). Restart the main app manually (e.g. ./talkie app)."
        fi
        return 0
    fi
    if [ "$main_changed" -eq 1 ]; then
        log_warn "Main app code also changed. Restart the main app manually to pick up those changes."
    fi
    init_compose
    local to_restart=""
    [ "$speech_changed" -eq 1 ] && to_restart="$to_restart speech"
    [ "$rag_changed" -eq 1 ]   && to_restart="$to_restart rag"
    [ "$browser_changed" -eq 1 ] && to_restart="$to_restart browser"
    [ "$healthbeat_changed" -eq 1 ] && to_restart="$to_restart healthbeat"
    to_restart=$(echo "$to_restart" | xargs)
    if [ -z "$to_restart" ]; then
        return 0
    fi
    log_info "Rebuilding module image(s) (code changed)..."
    $COMPOSE_CMD build $to_restart 2>/dev/null || $COMPOSE_CMD build $to_restart
    log_info "Restarting only affected containers: $to_restart"
    $COMPOSE_CMD restart $to_restart
    log_info "Done. Restarted: $to_restart"
}

# Clean up
cmd_clean() {
    local what="${1:-containers}"
    init_compose
    
    case "$what" in
        containers)
            log_warn "Stopping and removing all Talkie containers..."
            $COMPOSE_CMD down
            log_info "Containers cleaned up"
            ;;
        volumes)
            log_warn "Removing all Talkie volumes (this will delete data)..."
            read -p "Are you sure? This will delete all data! [y/N] " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                $COMPOSE_CMD down -v
                log_info "Volumes removed"
            else
                log_info "Cancelled"
            fi
            ;;
        all)
            log_warn "Removing all Talkie containers and volumes (this will delete data)..."
            read -p "Are you sure? This will delete all data! [y/N] " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                $COMPOSE_CMD down -v
                podman volume prune -f 2>/dev/null || true
                log_info "Everything cleaned up"
            else
                log_info "Cancelled"
            fi
            ;;
        *)
            log_error "Unknown clean option: $what"
            echo "Usage: ./talkie clean [containers|volumes|all]"
            exit 1
            ;;
    esac
}

# Health check
cmd_health() {
    log_info "Checking service health..."
    
    # Check Consul
    if curl -s http://localhost:8500/v1/status/leader > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} Consul: healthy"
    else
        echo -e "  ${RED}✗${NC} Consul: not responding"
    fi
    
    # Check KeyDB
    if podman exec talkie-keydb keydb-cli ping > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} KeyDB: healthy"
    else
        echo -e "  ${RED}✗${NC} KeyDB: not responding"
    fi
    
    # Check HAProxy
    if curl -s http://localhost:8404 > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} HAProxy: healthy"
    else
        echo -e "  ${RED}✗${NC} HAProxy: not responding"
    fi
    
    # Check Ollama
    if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} Ollama: healthy"
    else
        echo -e "  ${RED}✗${NC} Ollama: not responding"
    fi
    
    # Check Chroma
    if curl -s http://localhost:8000/api/v1/heartbeat > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} Chroma: healthy"
    else
        echo -e "  ${RED}✗${NC} Chroma: not responding"
    fi
    
    # Check module servers (speech=8001, rag=8002, browser=8003)
    for port in 8001 8002 8003; do
        if curl -s "http://localhost:$port/health" > /dev/null 2>&1; then
            echo -e "  ${GREEN}✓${NC} Module server on port $port: healthy"
        else
            echo -e "  ${YELLOW}!${NC} Module server on port $port: not responding (may not be started)"
        fi
    done
}

# Show usage
usage() {
    cat << EOF
Talkie Service Management CLI

Usage: ./talkie <command> [options]

Commands:
  start [target]
        Start services (default: all). Target: all, infrastructure, core, modules,
        web, or a single service (consul-server, keydb, haproxy, ollama, chroma,
        speech, rag, browser, healthbeat).
        - all: infrastructure + core + modules + Web UI (http://localhost:8765)
        - infrastructure: Consul, KeyDB, HAProxy
        - core: Ollama, Chroma
        - modules: speech, rag, browser, healthbeat
        - web: Web UI only (run_web.py, port 8765)

  stop [target]
        Stop services (default: all). Same targets as start.

  restart [target]
        Restart services (default: all). Same targets as start.

  status [web]
        Show status. No argument: all containers. With web: Web UI only.

  app [--local-only]
        Bring up container services then run the Web UI (foreground).
        - app: Web UI at http://localhost:8765
        - app --local-only: Skip module containers; app may start them as subprocesses

  restart-changed [REF]
        Restart only processes whose code has changed (git diff vs REF, default: HEAD).
        Rebuilds the module image if needed and restarts only affected module containers
        (speech, rag, browser, healthbeat). Main app changes are reported only.

  status  Show status of all services

  ps      List running containers

  logs <service> [--follow]
        View logs for a service
        Use --follow or -f to follow logs
        Example: ./talkie logs consul-server --follow

  health  Check health of all services

  clean [containers|volumes|all]
        Clean up resources
        - containers: Stop and remove containers
        - volumes: Remove volumes (deletes data)
        - all: Remove everything

  help    Show this help message

Examples:
  ./talkie start                    # Start all services + Web UI (http://localhost:8765)
  ./talkie start web                 # Start Web UI only
  ./talkie restart haproxy           # Restart HAProxy only
  ./talkie restart web               # Restart Web UI only
  ./talkie stop web                  # Stop Web UI
  ./talkie status                    # All containers
  ./talkie status web                # Web UI only
  ./talkie app                      # Start services + Web UI (foreground)
  ./talkie app --local-only         # Start Web UI only (no module containers)
  ./talkie logs consul-server -f   # Follow Consul logs
  ./talkie health                   # Check service health
  ./talkie restart-changed          # Restart only containers whose code changed
  ./talkie clean containers         # Clean up containers

EOF
}

# Main command dispatcher
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        start)
            cmd_start "${1:-all}"
            ;;
        stop)
            cmd_stop "${1:-all}"
            ;;
        restart)
            cmd_restart "${1:-all}"
            ;;
        app)
            cmd_app "$@"
            ;;
        restart-changed)
            cmd_restart_changed "${1:-HEAD}"
            ;;
        logs)
            cmd_logs "$1" "$2"
            ;;
        status)
            if [ "${1:-}" = "web" ]; then
                cmd_web_status
            else
                cmd_status
            fi
            ;;
        ps)
            cmd_ps
            ;;
        health)
            cmd_health
            ;;
        clean)
            cmd_clean "${1:-containers}"
            ;;
        help|--help|-h)
            usage
            ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            usage
            exit 1
            ;;
    esac
}

main "$@"
